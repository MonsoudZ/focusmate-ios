name: iOS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install swiftlint swiftformat peripheryapp/periphery/periphery
        
    - name: SwiftLint
      run: swiftlint
      
    - name: SwiftFormat
      run: swiftformat . --lint
      
    - name: Periphery (Dead Code Detection)
      run: |
        # Skip periphery for now due to project configuration issues
        echo "Skipping periphery scan - project configuration needs adjustment"
        # periphery scan --workspace focusmate.xcodeproj --schemes "focusmate" --retain-public
      
    - name: Prepare Simulator
      run: |
        # Xcode 16+ ships simulator runtimes as optional downloads.
        # Download the iOS platform if no runtimes are installed.
        if ! xcrun simctl list runtimes | grep -q 'iOS'; then
          echo "Downloading iOS simulator runtime..."
          xcodebuild -downloadPlatform iOS
        fi
        # List available simulators for debugging
        xcrun simctl list devices available | head -20

    - name: Build and Test
      env:
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      run: |
        xcodebuild -scheme "focusmate" -project "focusmate.xcodeproj" -destination "platform=iOS Simulator,name=iPhone 16" -derivedDataPath build clean test -enableCodeCoverage YES SENTRY_DSN="$SENTRY_DSN"
        
    - name: Check for Raw Networking
      run: |
        # Ensure no Swift files use URLSession directly (must go through APIClient)
        HITS=$(grep -rn 'URLSession\.\(shared\|init\)' focusmate/Focusmate --include='*.swift' \
          | grep -v 'InternalNetworking.swift' \
          | grep -v 'MockURLProtocol.swift' \
          | grep -v '// swiftlint:' || true)
        if [ -n "$HITS" ]; then
          echo "❌ Raw URLSession usage found — use APIClient instead:"
          echo "$HITS"
          exit 1
        fi
        echo "✅ No raw URLSession usage detected"

    - name: Coverage Gate (>=40%)
      run: |
        xcrun xccov view --report --json build/Logs/Test/*.xcresult > coverage.json
        python3 - <<'PY'
        import json, sys
        d = json.load(open('coverage.json'))
        # Find the main app target (skip test bundles)
        target = None
        for t in d.get('targets', []):
            if t['name'].endswith('.app'):
                target = t
                break
        if target is None:
            target = d['targets'][0] if d.get('targets') else None
        if target is None:
            print("No coverage targets found")
            sys.exit(1)
        # lineCoverage is a float 0.0-1.0
        pct = target['lineCoverage'] * 100
        print(f"Target: {target['name']}")
        print(f"Coverage: {pct:.1f}%")
        sys.exit(0 if pct >= 40 else 1)
        PY
        
    - name: Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.json
        flags: ios
        name: ios-coverage
