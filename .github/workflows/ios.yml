name: iOS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install swiftlint swiftformat peripheryapp/periphery/periphery
        
    - name: SwiftLint
      run: swiftlint
      
    - name: SwiftFormat
      run: swiftformat . --lint
      
    - name: Periphery (Dead Code Detection)
      run: |
        # Skip periphery for now due to project configuration issues
        echo "Skipping periphery scan - project configuration needs adjustment"
        # periphery scan --workspace focusmate.xcodeproj --schemes "focusmate" --retain-public
      
    - name: Build and Test
      run: |
        xcodebuild -scheme "focusmate" -project "focusmate/focusmate.xcodeproj" -destination "platform=iOS Simulator,name=iPhone 16" clean test -enableCodeCoverage YES
        
    - name: Check for Raw Networking
      run: bash Scripts/check_no_raw_networking.sh
      
    - name: Coverage Gate (>=40%)
      run: |
        xcrun xccov view --report --json build/Logs/Test/*.xcresult > coverage.json
        python3 - <<'PY'
        import json,sys
        d=json.load(open('coverage.json'))
        pct=d['targets'][0]['lineCoverage']['percentage']
        print(f"Coverage: {pct:.1f}%")
        sys.exit(0 if pct >= 40 else 1)
        PY
        
    - name: Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.json
        flags: ios
        name: ios-coverage
